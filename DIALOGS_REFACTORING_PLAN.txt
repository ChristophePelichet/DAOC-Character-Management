================================================================================
DIALOGS.PY REFACTORING PLAN
================================================================================
File: UI/dialogs.py
Date: 13 December 2025
Updated: 18 December 2025 (Phase 1 Complete - v0.109)
Purpose: Extract functions to dedicated modules for better maintainability
================================================================================

COMPLETED PHASES
================================================================================

âœ… PHASE 1: TEMPLATE PARSING (COMPLETED - v0.109)
================================================================================
Target File: Functions/template_parser.py (1392 lines)
Extracted: 8 functions from ArmorManagementDialog class
Removed from dialogs.py: 1381 lines
Date Completed: 18 December 2025
Branch: refactor/v0.109-dialogs-cleanup

Extracted Functions:
1. âœ… template_parse() - Main entry point for template parsing
2. âœ… template_detect_format() - Loki/Zenkcraft format detection
3. âœ… template_parse_loki() - Parse Loki format templates with full layout
4. âœ… template_parse_zenkcraft() - Parse Zenkcraft format templates
5. âœ… template_get_item_price() - Multi-source price lookup
6. âœ… template_format_item_with_price() - Item display formatting with icons
7. âœ… template_merge_columns() - 2-column layout with proper alignment
8. âœ… template_strip_color_markers() - Remove color markers for width calculation

Quality Metrics:
- PEP 8 compliant (line length <88 chars, type hints, docstrings)
- No hardcoded strings (all UI text uses lang.get())
- No French comments (English only in code)
- Complete documentation in ARMORY_TECHNICAL_DOCUMENTATION.md
- Full error handling with graceful degradation

Status: READY FOR PRODUCTION


GROUP 2: ITEM PRICE MANAGEMENT (High Priority)
================================================================================
Current Location: ArmorManagementDialog class
Target File: Functions/item_price_manager.py
Naming Convention: price_{action}_{object}

9. Function: _sync_template_prices_with_db()
   Purpose: Update item prices in template metadata from DB
   Lines: ~3141-3198
   New Name: price_sync_template()
   Notes: Updates .metadata.json with latest prices

10. Function: search_missing_prices()
    Purpose: Find items without prices in templates
    Lines: ~4881-4918
    New Name: price_find_missing_items()
    Notes: Opens SearchMissingPricesDialog


GROUP 3: CHARACTER DATA VALIDATION (Medium Priority)
================================================================================
Current Location: CharacterSheetWindow class
Target File: Functions/character_validator.py
Naming Convention: character_{action}_{object}
Target File: Functions/character_validator.py

11. Function: _populate_classes_sheet()
    Purpose: Populate class dropdown based on realm
    Lines: ~697-716
    New Name: character_get_classes_for_realm()
    Notes: Returns list of classes for given realm

12. Function: _populate_races_sheet()
    Purpose: Populate race dropdown based on class
    Lines: ~718-748
    New Name: character_get_races_for_class()
    Notes: Returns list of compatible races

13. Function: _on_realm_changed_sheet()
    Purpose: Update class/race dropdowns when realm changes
    Lines: ~750-756
    New Name: character_handle_realm_change()
    Notes: Cascade update logic

14. Function: _on_class_changed_sheet()
    Purpose: Update race dropdown when class changes
    Lines: ~758-765
    New Name: character_handle_class_change()
    Notes: Filter races by class compatibility

15. Function: _on_race_changed_sheet()
    Purpose: Update banner when race changes
    Lines: ~767-769
    New Name: character_handle_race_change()
    Notes: Triggers banner update


GROUP 4: REALM RANK CALCULATIONS (Medium Priority)
================================================================================
Current Location: CharacterSheetWindow class
Target File: Functions/realm_rank_calculator.py
Naming Convention: realm_rank_{action}_{object}

16. Function: update_rank_display()
    Purpose: Calculate and display RR from realm points
    Lines: ~823-839
    New Name: realm_rank_calculate_from_points()
    Notes: Uses realm_ranks.json data

17. Function: update_rp_info()
    Purpose: Update RP info labels (current, needed for next)
    Lines: ~807-821
    New Name: realm_rank_calculate_points_info()
    Notes: Calculates progression to next rank

18. Function: update_level_dropdown()
    Purpose: Filter level dropdown based on rank restrictions
    Lines: ~789-805
    New Name: realm_rank_get_valid_levels()
    Notes: Enforces min level requirements per rank


GROUP 5: HERALD SCRAPING LOGIC (High Priority)
================================================================================
Current Location: CharacterSheetWindow, HeraldSearchDialog
Target File: Functions/herald_integration.py
Naming Convention: herald_{action}_{object}

19. Function: update_from_herald()
    Purpose: Main function to scrape and update character from Herald
    Lines: ~1782-1851
    New Name: herald_update_character()
    Notes: Launches CharacterUpdateThread

20. Function: update_rvr_stats()
    Purpose: Update only RvR stats from Herald
    Lines: ~1278-1345
    New Name: herald_update_rvr_stats()
    Notes: Launches StatsUpdateThread

21. Function: _update_all_stats_ui()
    Purpose: Update all stat fields in UI after scraping
    Lines: ~1613-1710
    New Name: herald_apply_scraped_stats()
    Notes: Maps scraped data to UI fields

22. Function: _update_partial_stats_ui()
    Purpose: Update only some stat fields in UI
    Lines: ~1712-1780
    New Name: herald_apply_partial_stats()
    Notes: Selective update for RvR stats only


GROUP 6: CHARACTER BANNER MANAGEMENT (Low Priority)
================================================================================
Current Location: CharacterSheetWindow class
Target File: Functions/character_banner.py
Naming Convention: banner_{action}_{object}

23. Function: _update_class_banner()
    Purpose: Load and display class banner image
    Lines: ~643-688
    New Name: banner_load_class_image()
    Notes: Loads from Img/Banner/{realm}_{class}.png

24. Function: _set_banner_placeholder()
    Purpose: Display placeholder when banner not found
    Lines: ~690-695
    New Name: banner_set_placeholder()
    Notes: Shows colored placeholder with text


GROUP 7: HERALD URL VALIDATION (Medium Priority)
================================================================================
Current Location: CharacterSheetWindow class
Target File: Functions/herald_url_validator.py
Naming Convention: herald_url_{action}_{object}

25. Function: on_herald_url_changed()
    Purpose: Validate Herald URL format and update button states
    Lines: ~1077-1089
    New Name: herald_url_validate_format()
    Notes: Checks URL pattern, enables/disables buttons

26. Function: _update_herald_buttons_state()
    Purpose: Enable/disable Herald buttons based on connection state
    Lines: ~1574-1611
    New Name: herald_url_update_button_states()
    Notes: Checks Eden validation status

27. Function: open_herald_url()
    Purpose: Open Herald URL in browser
    Lines: ~1235-1262
    New Name: herald_url_open_in_browser()
    Notes: Launches browser with Herald URL


GROUP 8: ARMOR UPLOAD & PREVIEW (Medium Priority)
================================================================================
Current Location: ArmorManagementDialog class
Target File: Functions/armor_upload_handler.py
Naming Convention: armor_{action}_{object}

28. Function: upload_armor()
    Purpose: Show upload dialog and save armor configuration
    Lines: ~3035-3088
    New Name: armor_show_upload_dialog()
    Notes: Creates ArmorUploadPreviewDialog

29. Function: import_template()
    Purpose: Import armor template from file
    Lines: ~3090-3139
    New Name: armor_import_template()
    Notes: Opens TemplateImportDialog

30. Function: open_armor()
    Purpose: Open armor file in preview
    Lines: ~4729-4753
    New Name: armor_preview_file()
    Notes: Displays template content

31. Function: delete_armor()
    Purpose: Delete armor file with confirmation
    Lines: ~4755-4786
    New Name: armor_delete_file()
    Notes: Confirms and deletes .template file


GROUP 9: ITEM MODEL VIEWER (Low Priority)
================================================================================
Current Location: ArmorManagementDialog class
Target File: Functions/item_model_viewer.py
Naming Convention: item_model_{action}_{object}

32. Function: _on_model_link_clicked()
    Purpose: Handle click on ðŸ” icon to show item model
    Lines: ~4663-4676
    New Name: item_model_handle_icon_click()
    Notes: Extracts item name from URL

33. Function: _show_item_model()
    Purpose: Display 3D item model in dialog
    Lines: ~4678-4727
    New Name: item_model_show_3d_viewer()
    Notes: Opens ItemModelDialog with image


GROUP 10: ACHIEVEMENTS DISPLAY (Low Priority)
================================================================================
Current Location: CharacterSheetWindow class
Target File: Functions/achievement_formatter.py
Naming Convention: achievement_{action}_{object}

34. Function: _update_achievements_display()
    Purpose: Format and display achievements list
    Lines: ~1120-1233
    New Name: achievement_format_html_display()
    Notes: Generates HTML table with icons and descriptions


GROUP 11: CHARACTER RENAMING (Low Priority)
================================================================================
Current Location: CharacterSheetWindow class
Target File: Functions/character_rename_handler.py
Naming Convention: character_{action}_{object}

35. Function: rename_character()
    Purpose: Rename character with validation
    Lines: ~2126-2174
    New Name: character_rename_with_validation()
    Notes: Validates name, updates JSON file


GROUP 12: WORKER THREAD MANAGEMENT (Medium Priority)
================================================================================
Current Location: Various classes
Target File: Functions/herald_workers.py
Naming Convention: Keep PascalCase for classes (QThread subclasses)

36. Class: HeraldScraperWorker
    Purpose: Background thread for Herald scraping
    Lines: ~37-58
    New Name: Keep as HeraldScraperWorker
    Notes: QThread subclass

37. Class: ConnectionTestThread
    Purpose: Test Eden Herald connection
    Lines: ~5058-5075
    New Name: Keep as ConnectionTestThread
    Notes: QThread subclass

38. Class: StatsUpdateThread
    Purpose: Update character stats from Herald
    Lines: ~6196-6423
    New Name: Keep as StatsUpdateThread
    Notes: QThread subclass with step progress

39. Class: CharacterUpdateThread
    Purpose: Full character update from Herald
    Lines: ~6425-6732
    New Name: Keep as CharacterUpdateThread
    Notes: QThread subclass with step progress


GROUP 13: COOKIE MANAGEMENT (Keep in dialogs.py)
================================================================================
Note: CookieManagerDialog is complex UI, keep in dialogs.py
Lines: ~5077-5659


GROUP 14: SEARCH FUNCTIONALITY (Keep in dialogs.py)
================================================================================
Note: SearchThread and HeraldSearchDialog are tightly coupled to UI
Lines: ~5870-6194, ~6734-7590


GROUP 15: BACKUP SETTINGS (Keep in dialogs.py)
================================================================================
Note: BackupSettingsDialog is UI-heavy, keep in dialogs.py
Lines: ~7858-8446


GROUP 16: SIMPLE UTILITY FUNCTIONS (Low Priority)
================================================================================
Target File: Functions/ui_utils.py
Naming Convention: ui_{action}_{object}

40. Function: show_context_menu()
    Purpose: Show context menu for armor list
    Lines: ~4801-4835
    New Name: ui_create_armor_context_menu()
    Notes: Creates QMenu with actions


================================================================================
IMPLEMENTATION STRATEGY
================================================================================

================================================================================
IMPLEMENTATION PROGRESS
================================================================================

PHASE 1 - Template Parsing (COMPLETED âœ…)
================================================================================
Status: COMPLETED (18 Dec 2025)
File: Functions/template_parser.py (1272 lines created)
Cleaned from UI/dialogs.py: 1381 lines removed
Branch: refactor/v0.109-dialogs-phase-1-template-parser

Functions Extracted:
  âœ… template_parse() - Main entry point
  âœ… template_detect_format() - Format detection
  âœ… template_parse_loki() - Loki format parsing
  âœ… template_parse_zenkcraft() - Zenkcraft format parsing + equipment
  âœ… template_get_item_price() - Price lookup
  âœ… template_format_item_with_price() - Price formatting
  âœ… template_merge_columns() - 2-column layout
  âœ… template_strip_color_markers() - Width calculation helper

Result: All template parsing logic now in dedicated module (PEP 8 compliant)

---

PHASE 1b - Stats/Skills/Resistances/Bonuses Extraction (IN PROGRESS ðŸ”„)
================================================================================
Status: IN PROGRESS (Feature branch: feature/v0.110-dialogs-phase-2-stats-skills)
Target: Extract stats/skills/resistances/bonuses section to dedicated function
Expected lines to remove: ~250-350 from dialogs.py

Functions to Create/Refactor:
  â–¡ template_parse_zenkcraft_stats_section() - NEW
    Purpose: Separate stats/skills/resistances/bonuses parsing
    Input: stats, skills, resistances, bonuses dicts
    Output: Formatted HTML with 2-column layout
    Helper: Use existing template_merge_columns()
    
  â–¡ Refactor template_merge_columns() if needed for reusability
    Current users: template_parse_zenkcraft() calls it twice

Affected File: UI/dialogs.py
  - Remove stats/skills/resistances/bonuses inline code
  - Call template_parse_zenkcraft_stats_section()
  - Keep color logic consistent

---

PHASE 2 - Item Price Management (PLANNED ðŸ“‹)
================================================================================
Status: PENDING
Target File: Functions/item_price_manager.py
Naming Convention: price_* prefix

Functions:
  â–¡ price_sync_template() - Update prices in metadata JSON
  â–¡ price_find_missing_items() - Find items without prices

Expected Result: Dedicated price management module

---

PHASE 3 - Herald Integration (PLANNED ðŸ“‹)
================================================================================
Status: PENDING
Target Files: 
  - Functions/herald_integration.py (herald_* prefix)
  - Functions/herald_workers.py (worker threads)

---

PHASE 4 - Character Validation (PLANNED ðŸ“‹)
================================================================================
Status: PENDING
Target File: Functions/character_validator.py
Naming Convention: character_* prefix

---

PHASE 5 - Realm Rank & Achievements (PLANNED ðŸ“‹)
================================================================================
Status: PENDING
Target Files:
  - Functions/realm_rank_calculator.py (realm_rank_* prefix)
  - Functions/achievement_formatter.py (achievement_* prefix)

---

PHASE 6 - Armor & Model Viewer (PLANNED ðŸ“‹)
================================================================================
Status: PENDING
Target Files:
  - Functions/armor_upload_handler.py (armor_* prefix)
  - Functions/item_model_viewer.py (item_model_* prefix)

---

PHASE 7 - Misc Utilities (PLANNED ðŸ“‹)
================================================================================
Status: PENDING
Target Files:
  - Functions/character_banner.py (banner_* prefix)
  - Functions/herald_url_validator.py (herald_url_* prefix)
  - Functions/character_rename_handler.py (character_* prefix)
  - Functions/ui_utils.py (ui_* prefix)

================================================================================
PHASE 1 - Template Parsing (PRIORITY 1)
  â†’ Create Functions/template_parser.py
  â†’ Extract functions 1-8 (template parsing logic)
  â†’ All functions use template_* prefix
  â†’ Test with existing templates
  â†’ Update ArmorManagementDialog to use new module

PHASE 2 - Item Price Management (PRIORITY 2)
  â†’ Create Functions/item_price_manager.py
  â†’ Extract functions 9-10
  â†’ All functions use price_* prefix
  â†’ Test price sync and search

PHASE 3 - Herald Integration (PRIORITY 3)
  â†’ Create Functions/herald_integration.py
  â†’ Extract functions 19-22
  â†’ All functions use herald_* prefix
  â†’ Move worker threads to Functions/herald_workers.py (36-39)
  â†’ Test Herald scraping and updates

PHASE 4 - Character Validation (PRIORITY 4)
  â†’ Create Functions/character_validator.py
  â†’ Extract functions 11-15
  â†’ All functions use character_* prefix
  â†’ Test realm/class/race cascading

PHASE 5 - Realm Rank & Achievements (PRIORITY 5)
  â†’ Create Functions/realm_rank_calculator.py
  â†’ Extract functions 16-18
  â†’ All functions use realm_rank_* prefix
  â†’ Create Functions/achievement_formatter.py
  â†’ Extract function 34
  â†’ Use achievement_* prefix

PHASE 6 - Armor & Model Viewer (PRIORITY 6)
  â†’ Create Functions/armor_upload_handler.py
  â†’ Extract functions 28-31
  â†’ All functions use armor_* prefix
  â†’ Create Functions/item_model_viewer.py
  â†’ Extract functions 32-33
  â†’ Use item_model_* prefix

PHASE 7 - Misc Utilities (PRIORITY 7)
  â†’ Create Functions/character_banner.py (23-24) - banner_* prefix
  â†’ Create Functions/herald_url_validator.py (25-27) - herald_url_* prefix
  â†’ Create Functions/character_rename_handler.py (35) - character_* prefix
  â†’ Create Functions/ui_utils.py (40) - ui_* prefix


================================================================================
EXPECTED BENEFITS
================================================================================

1. Maintainability
   - Smaller, focused files (dialogs.py: 8765 â†’ ~4000 lines)
   - Clear separation of concerns
   - Easier to test individual functions

2. Reusability
   - Template parsing can be used by CLI tools
   - Herald integration reusable in automation scripts
   - Validation logic shared across dialogs

3. Performance
   - No performance impact (imports are cached)
   - Easier to profile specific functions
   - Better memory management

4. Testing
   - Each module can have dedicated unit tests
   - Mock external dependencies (DB, scraping)
   - Test edge cases in isolation

5. Documentation
   - Each module has focused docstrings
   - Technical documentation per feature
   - Examples in module docstrings


================================================================================
NOTES
================================================================================

- Keep all QDialog classes in dialogs.py (UI components)
- Move only business logic and utility functions
- Maintain backward compatibility (imports)
- Add proper docstrings to extracted functions
- Follow PEP 8 naming conventions
- Update tests after each phase
- Document each extraction in commit messages

================================================================================
END OF REFACTORING PLAN
================================================================================
